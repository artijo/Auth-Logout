/**
 * Universal Logout Handler v1.0.0
 * @author Bus Counter Team
 * @license MIT
 */
(function (g) {
  "use strict";
  const L = {
    STORAGE_TYPES: {
      LOCAL_STORAGE: "localStorage",
      SESSION_STORAGE: "sessionStorage",
      COOKIE: "cookie",
      ALL: "all",
      CUSTOM: "custom",
    },
    config: {
      defaultRedirectUrl: "https://authen-center.lab.bussing.app/login",
      storageType: "localStorage",
      localStorageKeys: [],
      sessionStorageKeys: [],
      cookieNames: [],
      cookieOptions: {
        path: "/",
        domain: null,
        secure: false,
        sameSite: "Lax",
      },
      clearAllLocalStorage: false,
      clearAllSessionStorage: false,
      clearAllCookies: false,
      redirectDelay: 500,
      customClearFn: null,
      onLogoutStart: null,
      onLogoutComplete: null,
      onRedirect: null,
      onError: null,
      debug: false,
    },
    log(...a) {
      this.config.debug && console.log("[LogoutHandler]", ...a);
    },
    init(c = {}) {
      return (
        (this.config = {
          ...this.config,
          ...c,
          cookieOptions: {
            ...this.config.cookieOptions,
            ...(c.cookieOptions || {}),
          },
        }),
        this.log("Initialized with config:", this.config),
        this
      );
    },
    reset() {
      return (
        (this.config = {
          defaultRedirectUrl: "https://authen-center.lab.bussing.app/login",
          storageType: "localStorage",
          localStorageKeys: [],
          sessionStorageKeys: [],
          cookieNames: [],
          cookieOptions: {
            path: "/",
            domain: null,
            secure: false,
            sameSite: "Lax",
          },
          clearAllLocalStorage: false,
          clearAllSessionStorage: false,
          clearAllCookies: false,
          redirectDelay: 500,
          customClearFn: null,
          onLogoutStart: null,
          onLogoutComplete: null,
          onRedirect: null,
          onError: null,
          debug: false,
        }),
        this
      );
    },
    clearLocalStorage() {
      if (typeof localStorage === "undefined") {
        this.log("localStorage is not available");
        return;
      }
      if (this.config.clearAllLocalStorage) {
        localStorage.clear();
        this.log("Cleared all localStorage");
      } else if (this.config.localStorageKeys.length > 0) {
        this.config.localStorageKeys.forEach((k) => {
          localStorage.removeItem(k);
          this.log("Removed localStorage key:", k);
        });
      }
    },
    clearSessionStorage() {
      if (typeof sessionStorage === "undefined") {
        this.log("sessionStorage is not available");
        return;
      }
      if (this.config.clearAllSessionStorage) {
        sessionStorage.clear();
        this.log("Cleared all sessionStorage");
      } else if (this.config.sessionStorageKeys.length > 0) {
        this.config.sessionStorageKeys.forEach((k) => {
          sessionStorage.removeItem(k);
          this.log("Removed sessionStorage key:", k);
        });
      }
    },
    deleteCookie(n, o = {}) {
      const opts = { ...this.config.cookieOptions, ...o };
      let c = `${encodeURIComponent(n)}=; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
      opts.path && (c += `; path=${opts.path}`);
      opts.domain && (c += `; domain=${opts.domain}`);
      opts.secure && (c += "; secure");
      opts.sameSite && (c += `; samesite=${opts.sameSite}`);
      document.cookie = c;
      this.log("Deleted cookie:", n);
    },
    getAllCookieNames() {
      return document.cookie
        .split(";")
        .map((c) => c.trim().split("=")[0])
        .filter((n) => n);
    },
    clearCookies() {
      if (typeof document === "undefined") {
        this.log("document is not available");
        return;
      }
      if (this.config.clearAllCookies) {
        this.getAllCookieNames().forEach((n) => {
          this.deleteCookie(n);
        });
        this.log("Cleared all cookies");
      } else if (this.config.cookieNames.length > 0) {
        this.config.cookieNames.forEach((n) => {
          this.deleteCookie(n);
        });
      }
    },
    async clearAuthData() {
      this.config.onLogoutStart && this.config.onLogoutStart();
      const s = this.config.storageType;
      switch (s) {
        case this.STORAGE_TYPES.LOCAL_STORAGE:
          this.clearLocalStorage();
          break;
        case this.STORAGE_TYPES.SESSION_STORAGE:
          this.clearSessionStorage();
          break;
        case this.STORAGE_TYPES.COOKIE:
          this.clearCookies();
          break;
        case this.STORAGE_TYPES.ALL:
          this.clearLocalStorage();
          this.clearSessionStorage();
          this.clearCookies();
          break;
        case this.STORAGE_TYPES.CUSTOM:
          this.config.customClearFn &&
            (await Promise.resolve(this.config.customClearFn()),
            this.log("Executed custom clear function"));
          break;
        default:
          this.log("Unknown storage type:", s);
      }
      s !== this.STORAGE_TYPES.CUSTOM &&
        this.config.customClearFn &&
        (await Promise.resolve(this.config.customClearFn()),
        this.log("Executed additional custom clear function"));
      this.config.onLogoutComplete && this.config.onLogoutComplete();
      this.log("Auth data cleared");
    },
    getNextUrl() {
      const u = window.location.href;
      try {
        const o = new URL(u);
        let n = o.searchParams.get("next");
        if (!n) {
          const p = u.split("logout")[1];
          if (p) {
            const m = p.match(/[?&]next=([^&]*)/);
            m && m[1] && (n = m[1]);
          }
        }
        const r = n ? decodeURIComponent(n) : null;
        this.log("Next URL:", r);
        return r;
      } catch (e) {
        this.log("Error parsing URL:", e);
        return null;
      }
    },
    getRemainingNextParams() {
      const u = window.location.href;
      const m = u.match(/[?&]next=[^&]*(&next=.*)$/);
      if (m && m[1]) {
        const r = m[1].substring(1);
        this.log("Remaining params:", r);
        return r;
      }
      return "";
    },
    buildRedirectUrl(n) {
      const r = this.getRemainingNextParams();
      if (!r) return n;
      const s = n.includes("?") ? "&" : "?";
      const f = `${n}${s}${r}`;
      this.log("Final redirect URL:", f);
      return f;
    },
    redirect(u) {
      this.config.onRedirect && this.config.onRedirect(u);
      this.log("Redirecting to:", u);
      setTimeout(() => {
        window.location.href = u;
      }, this.config.redirectDelay);
    },
    redirectToDefault() {
      this.redirect(this.config.defaultRedirectUrl);
    },
    async execute() {
      try {
        await this.clearAuthData();
        const n = this.getNextUrl();
        if (n) {
          const f = this.buildRedirectUrl(n);
          this.redirect(f);
        } else {
          this.redirectToDefault();
        }
      } catch (e) {
        console.error("[LogoutHandler] Error:", e);
        this.config.onError && this.config.onError(e);
        this.redirectToDefault();
      }
    },
  };
  typeof module !== "undefined" && module.exports && (module.exports = L);
  typeof define === "function" &&
    define.amd &&
    define([], function () {
      return L;
    });
  g.LogoutHandler = L;
})(typeof window !== "undefined" ? window : this);
