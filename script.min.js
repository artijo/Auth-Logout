/**
 * Universal Logout Handler v1.0.0
 * @author Bus Counter Team
 * @license MIT
 */ !function(e){"use strict";let t={STORAGE_TYPES:{LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage",COOKIE:"cookie",ALL:"all",CUSTOM:"custom"},config:{defaultRedirectUrl:"https://authen-center.lab.bussing.app/login",storageType:"localStorage",localStorageKeys:[],sessionStorageKeys:[],cookieNames:[],cookieOptions:{path:"/",domain:null,secure:!1,sameSite:"Lax"},clearAllLocalStorage:!1,clearAllSessionStorage:!1,clearAllCookies:!1,redirectDelay:500,customClearFn:null,onLogoutStart:null,onLogoutComplete:null,onRedirect:null,onError:null,debug:!1},log(...e){this.config.debug&&console.log("[LogoutHandler]",...e)},init(e={}){return this.config={...this.config,...e,cookieOptions:{...this.config.cookieOptions,...e.cookieOptions||{}}},this.log("Initialized with config:",this.config),this},reset(){return this.config={defaultRedirectUrl:"https://authen-center.lab.bussing.app/login",storageType:"localStorage",localStorageKeys:[],sessionStorageKeys:[],cookieNames:[],cookieOptions:{path:"/",domain:null,secure:!1,sameSite:"Lax"},clearAllLocalStorage:!1,clearAllSessionStorage:!1,clearAllCookies:!1,redirectDelay:500,customClearFn:null,onLogoutStart:null,onLogoutComplete:null,onRedirect:null,onError:null,debug:!1},this},clearLocalStorage(){if("undefined"==typeof localStorage){this.log("localStorage is not available");return}this.config.clearAllLocalStorage?(localStorage.clear(),this.log("Cleared all localStorage")):this.config.localStorageKeys.length>0&&this.config.localStorageKeys.forEach(e=>{localStorage.removeItem(e),this.log("Removed localStorage key:",e)})},clearSessionStorage(){if("undefined"==typeof sessionStorage){this.log("sessionStorage is not available");return}this.config.clearAllSessionStorage?(sessionStorage.clear(),this.log("Cleared all sessionStorage")):this.config.sessionStorageKeys.length>0&&this.config.sessionStorageKeys.forEach(e=>{sessionStorage.removeItem(e),this.log("Removed sessionStorage key:",e)})},deleteCookie(e,t={}){let o={...this.config.cookieOptions,...t},i=`${encodeURIComponent(e)}=; expires=Thu, 01 Jan 1970 00:00:00 GMT`;o.path&&(i+=`; path=${o.path}`),o.domain&&(i+=`; domain=${o.domain}`),o.secure&&(i+="; secure"),o.sameSite&&(i+=`; samesite=${o.sameSite}`),document.cookie=i,this.log("Deleted cookie:",e)},getAllCookieNames:()=>document.cookie.split(";").map(e=>e.trim().split("=")[0]).filter(e=>e),clearCookies(){if("undefined"==typeof document){this.log("document is not available");return}this.config.clearAllCookies?(this.getAllCookieNames().forEach(e=>{this.deleteCookie(e)}),this.log("Cleared all cookies")):this.config.cookieNames.length>0&&this.config.cookieNames.forEach(e=>{this.deleteCookie(e)})},async clearAuthData(){this.config.onLogoutStart&&this.config.onLogoutStart();let e=this.config.storageType;switch(e){case this.STORAGE_TYPES.LOCAL_STORAGE:this.clearLocalStorage();break;case this.STORAGE_TYPES.SESSION_STORAGE:this.clearSessionStorage();break;case this.STORAGE_TYPES.COOKIE:this.clearCookies();break;case this.STORAGE_TYPES.ALL:this.clearLocalStorage(),this.clearSessionStorage(),this.clearCookies();break;case this.STORAGE_TYPES.CUSTOM:this.config.customClearFn&&(await Promise.resolve(this.config.customClearFn()),this.log("Executed custom clear function"));break;default:this.log("Unknown storage type:",e)}e!==this.STORAGE_TYPES.CUSTOM&&this.config.customClearFn&&(await Promise.resolve(this.config.customClearFn()),this.log("Executed additional custom clear function")),this.config.onLogoutComplete&&this.config.onLogoutComplete(),this.log("Auth data cleared")},getNextUrl(){let e=window.location.href;try{let t=new URL(e).searchParams.get("next");if(!t){let o=e.split("logout")[1];if(o){let i=o.match(/[?&]next=([^&]*)/);i&&i[1]&&(t=i[1])}}let l=t?decodeURIComponent(t):null;return this.log("Next URL:",l),l}catch(s){return this.log("Error parsing URL:",s),null}},getRemainingNextParams(){let e=window.location.href.match(/[?&]next=[^&]*(&next=.*)$/);if(e&&e[1]){let t=e[1].substring(1);return this.log("Remaining params:",t),t}return""},buildRedirectUrl(e){let t=this.getRemainingNextParams();if(!t)return e;let o=`${e}${e.includes("?")?"&":"?"}${t}`;return this.log("Final redirect URL:",o),o},redirect(e){this.config.onRedirect&&this.config.onRedirect(e),this.log("Redirecting to:",e),setTimeout(()=>{window.location.href=e},this.config.redirectDelay)},redirectToDefault(){this.redirect(this.config.defaultRedirectUrl)},async execute(){try{await this.clearAuthData();let e=this.getNextUrl();if(e){let t=this.buildRedirectUrl(e);this.redirect(t)}else this.redirectToDefault()}catch(o){console.error("[LogoutHandler] Error:",o),this.config.onError&&this.config.onError(o),this.redirectToDefault()}}};"undefined"!=typeof module&&module.exports&&(module.exports=t),"function"==typeof define&&define.amd&&define([],function(){return t}),e.LogoutHandler=t}("undefined"!=typeof window?window:this);